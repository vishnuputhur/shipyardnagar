<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipyard Nagar - My Subscription</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Your existing CSS styles remain the same */
        :root {
            --primary-orange: #FF6B35;
            --orange-light: #FF8C42;
            --orange-dark: #E55A2B;
            --gradient: linear-gradient(135deg, #FF6B35 0%, #FF8C42 50%, #FFA726 100%);
            --shadow: 0 8px 25px rgba(255, 107, 53, 0.15);
            --shadow-hover: 0 12px 35px rgba(255, 107, 53, 0.25);
            --card-bg: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] {
            --card-bg: rgba(45, 45, 45, 0.95);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 0;
            position: relative;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        /* ... (rest of your CSS remains exactly the same) ... */
        
        /* Alternative Payment Methods */
        .alternative-payment {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f0fff0 0%, #e6ffe6 100%);
            border: 1px solid #90ee90;
        }
        
        [data-theme="dark"] .alternative-payment {
            background: linear-gradient(135deg, #1a3d1a 0%, #2d4a2d 100%);
            border-color: #4a764a;
        }
        
        .alternative-title {
            font-weight: 600;
            color: #228b22;
            margin-bottom: 10px;
        }
        
        [data-theme="dark"] .alternative-title {
            color: #90ee90;
        }
        
        .qr-code {
            text-align: center;
            margin: 15px 0;
        }
        
        .qr-code img {
            max-width: 200px;
            border: 2px solid #ddd;
            border-radius: 10px;
        }
        
        .manual-payment {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #007bff;
        }
        
        [data-theme="dark"] .manual-payment {
            background: #2d3748;
            border-left-color: #60a5fa;
        }

        /* Keep all your existing CSS styles */
    </style>
</head>
<body>
    <!-- Header Image - Fixed at top -->
    <img src="assets/head.png" alt="Header" class="header-image">
    
    <main class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-8 col-lg-6">
                <div class="main-card">
                    <div class="page-title">
                        My Subscription
                    </div>
                    
                    <!-- Due Amount Section -->
                    <div class="subs-info">
                        <i class="fas fa-money-bill-wave"></i>
                        <span id="dueInfo">Due Amount: â‚¹0</span>
                    </div>
                    
                    <div class="subs-info">
                        <i class="fas fa-calendar-times"></i>
                        <span id="pendingMonths">Pending: 0 months</span>
                    </div>
                    
                    <!-- Payment Status Message -->
                    <div id="paymentStatus" class="payment-status"></div>
                    
                    <!-- Payment Form -->
                    <div class="payment-form">
                        <h5 class="mb-3" style="color: #1e3a8a; font-weight: 600;">Pay Monthly Subscription</h5>
                        
                        <form id="paymentForm">
                            <div class="form-group">
                                <label for="amount" class="form-label">Amount (â‚¹)</label>
                                <input type="number" class="form-control" id="amount" value="0" min="10" step="10">
                                <small class="form-text text-muted">You can edit the amount if needed</small>
                            </div>
                            
                            <!-- Speaker Contribution Section -->
                            <div class="speaker-contribution" id="speakerSection">
                                <div class="speaker-header">
                                    <i class="fas fa-volume-up"></i>
                                    <span class="speaker-title">Speaker Contribution</span>
                                </div>
                                <div class="speaker-description">
                                    We purchased a speaker for community events. Please contribute â‚¹500 for the same.
                                </div>
                                <div class="speaker-option">
                                    <input type="checkbox" id="includeSpeaker" name="includeSpeaker" value="500" checked>
                                    <label for="includeSpeaker">Include speaker contribution of <span class="speaker-amount">â‚¹500</span></label>
                                </div>
                                <div id="speakerStatus" class="speaker-status pending">Speaker Contribution: Pending</div>
                            </div>
                            
                            <!-- UPI Payment Button -->
                            <button type="submit" class="pay-btn" id="payButton">
                                <i class="fas fa-credit-card me-2"></i>
                                Pay via UPI
                            </button>
                            
                            <!-- Payment Note -->
                            <div class="payment-note">
                                If UPI fails, use alternative payment methods below
                            </div>
                        </form>
                        
                        <!-- Alternative Payment Methods -->
                        <div class="alternative-payment">
                            <div class="alternative-title">
                                <i class="fas fa-qrcode me-2"></i>Alternative Payment Methods
                            </div>
                            
                            <!-- QR Code Payment -->
                            <div class="qr-code">
                                <p><strong>Scan QR Code to Pay</strong></p>
                                <div id="qrCodeContainer">
                                    <!-- QR code will be generated here -->
                                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                                        <p style="margin-bottom: 10px; font-weight: 500;">UPI QR Code</p>
                                        <div style="background: white; padding: 15px; display: inline-block; border-radius: 8px;">
                                            <!-- Simple QR code representation -->
                                            <div style="font-family: monospace; line-height: 1;">
                                                <div>â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“</div>
                                                <div>â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–“â–“</div>
                                                <div>â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–“â–“</div>
                                                <div>â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–“â–“</div>
                                                <div>â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–“â–“</div>
                                                <div>â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–“â–“</div>
                                                <div>â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–“â–“â–‘â–‘â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–“â–“</div>
                                                <div>â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“</div>
                                            </div>
                                        </div>
                                        <p style="margin-top: 10px; font-size: 0.8rem; color: #666;">
                                            UPI ID: 9037383927@okbizaxis
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Manual Payment Instructions -->
                            <div class="manual-payment">
                                <p><strong>Manual Payment Instructions:</strong></p>
                                <ol style="font-size: 0.85rem; margin-bottom: 0;">
                                    <li>Open your UPI app (Google Pay, PhonePe, Paytm, etc.)</li>
                                    <li>Send money to: <strong>9037383927@okbizaxis</strong></li>
                                    <li>Enter the amount shown above</li>
                                    <li>Add note: "Shipyard Nagar - Member [Your Number]"</li>
                                    <li>Complete payment and screenshot the receipt</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment History -->
                    <div class="payment-history">
                        <h5 class="mb-3" style="color: #1e3a8a; font-weight: 600;">Payment History</h5>
                        
                        <div class="table-container">
                            <table class="payment-table">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Status</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="contributionTable">
                                    <!-- Payment history will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer>
        <div class="footer-text">
            <p>Powered by VTSoft 2025</p>
        </div>
        <button id="themeToggle" class="theme-toggle-btn">ðŸŒž</button>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBWswawf9tpxNwVU0BaJ6FCwCvgcjUQXlA",
            authDomain: "shipyard-nagar.firebaseapp.com",
            projectId: "shipyard-nagar",
            storageBucket: "shipyard-nagar.firebasestorage.app",
            messagingSenderId: "552855824221",
            appId: "1:552855824221:web:f709da953077475be9eab4",
            measurementId: "G-V8CQ4YCCQ5"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentMemberNumber = '';
        let speakerPaid = false;
        let monthlyDueAmount = 0;
        let paymentInProgress = false;

        // Auth State Listener
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (!userDoc.exists) {
                        alert('User data not found. Redirecting to login...');
                        window.location.href = 'login.html';
                        return;
                    }

                    currentMemberNumber = userDoc.data().memberNumber || 'Unknown';
                    await loadSubscriptions(user.uid);
                } catch (error) {
                    alert('Error loading user data: ' + error.message);
                    console.error('Error:', error);
                }
            }
        });

        // Generate Months
        const generateMonths = (start, end) => {
            const months = [];
            let current = new Date(start + '-01');
            const endDate = new Date(end + '-01');
            while (current <= endDate) {
                months.push(current.toISOString().slice(0, 7));
                current.setMonth(current.getMonth() + 1);
            }
            return months;
        };

        // Get Month Name
        const getMonthName = (monthString) => {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthIndex = parseInt(monthString.split('-')[1]) - 1;
            return months[monthIndex] + ' ' + monthString.split('-')[0];
        };

        // Load Subscriptions
        const loadSubscriptions = async (userId) => {
            const currentDate = new Date();
            const currentMonth = currentDate.toISOString().slice(0, 7);
            const startMonth = '2025-10';

            try {
                const contributionsSnap = await db.collection('contributions').doc(userId).collection('months').get();
                const userDoc = await db.collection('users').doc(userId).get();
                
                speakerPaid = userDoc.data().speakerPaid || false;
                
                const speakerStatus = document.getElementById('speakerStatus');
                const speakerSection = document.getElementById('speakerSection');
                
                if (speakerPaid) {
                    speakerStatus.textContent = 'Speaker Contribution: Paid';
                    speakerStatus.className = 'speaker-status paid';
                    speakerSection.style.display = 'none';
                } else {
                    speakerStatus.textContent = 'Speaker Contribution: Pending';
                    speakerStatus.className = 'speaker-status pending';
                    speakerSection.style.display = 'block';
                }
                
                const paidData = {};
                const paidMonths = [];
                
                contributionsSnap.forEach(doc => {
                    paidData[doc.id] = doc.data();
                    if (doc.data().paid) {
                        paidMonths.push(doc.id);
                    }
                });

                let latestPaidMonth = startMonth;
                paidMonths.forEach(month => {
                    if (month > latestPaidMonth) {
                        latestPaidMonth = month;
                    }
                });

                const endMonth = currentMonth > latestPaidMonth ? currentMonth : latestPaidMonth;
                const allMonths = generateMonths(startMonth, endMonth);

                let unpaidMonths = [];
                const contributionTable = document.getElementById('contributionTable');
                contributionTable.innerHTML = '';

                const sortedMonths = [...allMonths].sort().reverse();

                sortedMonths.forEach(month => {
                    const data = paidData[month] || { paid: false, amount: 0, date: '' };
                    const status = data.paid ? 'Paid' : 'Pending';
                    const amount = data.paid ? 'â‚¹200' : 'â‚¹0';
                    const date = data.date || '-';

                    contributionTable.innerHTML += `
                        <tr>
                            <td>${getMonthName(month)}</td>
                            <td class="${data.paid ? 'status-paid' : 'status-pending'}">${status}</td>
                            <td>${amount}</td>
                            <td>${date}</td>
                        </tr>
                    `;

                    if (!data.paid) {
                        unpaidMonths.push(getMonthName(month));
                    }
                });

                monthlyDueAmount = unpaidMonths.length * 200;
                updateAmountField();
                
                document.getElementById('dueInfo').textContent = `Due Amount: â‚¹${monthlyDueAmount}`;
                
                if (unpaidMonths.length > 0) {
                    document.getElementById('pendingMonths').textContent = `Pending: ${unpaidMonths.join(', ')}`;
                } else {
                    document.getElementById('pendingMonths').textContent = 'All months paid';
                }
            } catch (error) {
                alert('Error loading subscriptions: ' + error.message);
                console.error('Error:', error);
            }
        };

        // Update amount field based on speaker selection
        function updateAmountField() {
            const includeSpeaker = document.getElementById('includeSpeaker').checked;
            let totalAmount = monthlyDueAmount;
            
            if (includeSpeaker && !speakerPaid) {
                totalAmount += 500;
            }
            
            document.getElementById('amount').value = totalAmount;
        }

        // Handle speaker contribution option
        document.getElementById('includeSpeaker').addEventListener('change', function() {
            updateAmountField();
        });

        // Show payment status message
        function showPaymentStatus(message, type) {
            const statusElement = document.getElementById('paymentStatus');
            statusElement.textContent = message;
            statusElement.className = `payment-status ${type}`;
            statusElement.style.display = 'block';
            
            if (type === 'info') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }
        }

        // Payment Form Submit - FIXED: Multiple UPI URL formats to try
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (paymentInProgress) {
                showPaymentStatus('Payment already in progress. Please wait...', 'info');
                return;
            }
            
            const amount = document.getElementById('amount').value;
            const includeSpeaker = document.getElementById('includeSpeaker').checked;
            
            if (amount < 10) {
                showPaymentStatus('Please enter minimum â‚¹10!', 'error');
                return;
            }

            if (amount <= 0) {
                showPaymentStatus('Please enter a valid amount!', 'error');
                return;
            }

            paymentInProgress = true;
            const payButton = document.getElementById('payButton');
            payButton.disabled = true;
            payButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

            try {
                const upiID = '9037383927@okbizaxis';
                const cleanAmount = parseInt(amount);
                
                // Try multiple UPI URL formats
                const upiURLs = [
                    // Format 1: Simple without payee name
                    `upi://pay?pa=${encodeURIComponent(upiID)}&am=${cleanAmount}&cu=INR`,
                    
                    // Format 2: With minimal parameters
                    `upi://pay?pa=${encodeURIComponent(upiID)}&pn=Community&am=${cleanAmount}&cu=INR`,
                    
                    // Format 3: With transaction note
                    `upi://pay?pa=${encodeURIComponent(upiID)}&pn=Community&am=${cleanAmount}&cu=INR&tn=Shipyard+Nagar+Subscription`,
                    
                    // Format 4: Alternative syntax
                    `upi://pay?pa=${upiID}&am=${cleanAmount}&cu=INR`
                ];

                let success = false;
                
                // Try each URL format
                for (let i = 0; i < upiURLs.length; i++) {
                    try {
                        console.log('Trying UPI URL format:', i + 1, upiURLs[i]);
                        
                        // Create hidden iframe to test URL
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.src = upiURLs[i];
                        document.body.appendChild(iframe);
                        
                        // Also try direct navigation
                        setTimeout(() => {
                            window.location.href = upiURLs[i];
                        }, 100);
                        
                        success = true;
                        break;
                        
                    } catch (error) {
                        console.log(`URL format ${i + 1} failed:`, error);
                        continue;
                    }
                }
                
                if (!success) {
                    showPaymentStatus('Could not initiate UPI payment. Please use QR code or manual payment.', 'error');
                } else {
                    showPaymentStatus('Opening UPI app... If payment fails, use QR code below.', 'info');
                    
                    // Store payment details
                    const paymentDetails = {
                        amount: cleanAmount,
                        includeSpeaker: includeSpeaker,
                        timestamp: new Date().toISOString(),
                        status: 'initiated'
                    };
                    
                    localStorage.setItem('lastPayment', JSON.stringify(paymentDetails));
                    
                    // Set timeout to reset button
                    setTimeout(() => {
                        paymentInProgress = false;
                        payButton.disabled = false;
                        payButton.innerHTML = '<i class="fas fa-credit-card me-2"></i>Pay via UPI';
                    }, 10000);
                }
                
            } catch (error) {
                console.error('Payment initiation error:', error);
                showPaymentStatus('Error initiating payment. Please use alternative methods.', 'error');
                paymentInProgress = false;
                payButton.disabled = false;
                payButton.innerHTML = '<i class="fas fa-credit-card me-2"></i>Pay via UPI';
            }
        });

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                const html = document.documentElement;
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                themeToggle.textContent = newTheme === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
            });

            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            themeToggle.textContent = savedTheme === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
        }

        // Check for returning from UPI payment
        window.addEventListener('load', () => {
            const lastPayment = localStorage.getItem('lastPayment');
            if (lastPayment) {
                const payment = JSON.parse(lastPayment);
                const timeDiff = new Date() - new Date(payment.timestamp);
                
                if (timeDiff < 120000) {
                    showPaymentStatus('Returned from payment. If successful, it will be updated soon.', 'info');
                    setTimeout(() => {
                        localStorage.removeItem('lastPayment');
                    }, 5000);
                } else {
                    localStorage.removeItem('lastPayment');
                }
            }
        });

        // Add contact information for payment issues
        function showAdminContact() {
            showPaymentStatus('For payment issues, contact: 9037383927 (Admin)', 'info');
        }

        // Add click event to QR code area
        document.getElementById('qrCodeContainer').addEventListener('click', function() {
            showPaymentStatus('UPI ID: 9037383927@okbizaxis - Use this ID in any UPI app', 'info');
        });
    </script>
</body>
</html>