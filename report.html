<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipyard Nagar - Download Reports</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-orange: #FF6B35;
            --orange-light: #FF8C42;
            --orange-dark: #E55A2B;
            --gradient: linear-gradient(135deg, #FF6B35 0%, #FF8C42 50%, #FFA726 100%);
            --shadow: 0 8px 25px rgba(255, 107, 53, 0.15);
            --shadow-hover: 0 12px 35px rgba(255, 107, 53, 0.25);
            --card-bg: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] {
            --card-bg: rgba(45, 45, 45, 0.95);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 0;
            position: relative;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><polygon fill="%23ffffff10" points="0,1000 1000,0 1000,1000"/></svg>');
            pointer-events: none;
            z-index: -1;
        }

        /* Header Image - Fixed at top */
        .header-image {
            width: 100%;
            height: auto;
            max-height: 150px;
            object-fit: cover;
            display: block;
            position: fixed;
            top: 3mm;
            left: 0;
            z-index: 999;
        }

        /* Main Card - Reduced top gap */
        .main-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 50px;
            position: relative;
            margin-top: 120px;
        }

        /* Page Title */
        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 30px;
            text-align: center;
        }

        [data-theme="dark"] .page-title {
            color: #60a5fa;
        }

        /* Footer - Reduced height */
        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(248, 248, 248, 0.9);
            backdrop-filter: blur(10px);
            color: #666;
            font-size: 0.7rem;
            z-index: 1000;
            border-top: 1px solid rgba(255, 107, 53, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 15px;
            height: 30px;
        }

        [data-theme="dark"] footer {
            background: rgba(45, 45, 45, 0.9);
            color: #ccc;
        }

        .footer-text {
            flex: 1;
            text-align: center;
        }

        /* Theme Toggle - Slightly larger */
        .theme-toggle-btn {
            background: transparent;
            border: 1px solid #ccc;
            border-radius: 20px;
            padding: 4px 8px;
            color: #666;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 24px;
        }

        [data-theme="dark"] .theme-toggle-btn {
            border-color: #666;
            color: #ccc;
        }

        .theme-toggle-btn:hover {
            background: var(--gradient);
            color: white;
            border-color: var(--primary-orange);
        }

        /* Back Button */
        .back-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 25px;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
            color: white;
        }

        /* Report Form */
        .report-form {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
        }

        [data-theme="dark"] .form-label {
            color: #fff;
        }

        .form-select {
            border-radius: 10px;
            border: 1px solid #ddd;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .form-select {
            background: #444;
            border-color: #555;
            color: #fff;
        }

        .form-select:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2);
        }

        /* Download Button */
        .download-btn {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .download-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(30, 58, 138, 0.3);
        }

        .download-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Loading Spinner */
        #loadingSpinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: var(--shadow-hover);
            z-index: 9999;
            text-align: center;
            min-width: 200px;
        }

        .spinner-text {
            font-size: 1.2rem;
            color: #1e3a8a;
            margin-top: 15px;
        }

        [data-theme="dark"] .spinner-text {
            color: #60a5fa;
        }

        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .success-message {
            background: rgba(40, 167, 69, 0.1);
            color: #155724;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        [data-theme="dark"] .success-message {
            background: rgba(40, 167, 69, 0.2);
            color: #8affa8;
        }

        .error-message {
            background: rgba(220, 53, 69, 0.1);
            color: #721c24;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        [data-theme="dark"] .error-message {
            background: rgba(220, 53, 69, 0.2);
            color: #ff8a8a;
        }

        /* Responsive */
        @media (max-width: 576px) {
            .header-image {
                max-height: 120px;
            }
            
            .main-card {
                padding: 20px;
                margin: 100px 10px 50px 10px;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            footer {
                padding: 3px 10px;
                height: 28px;
            }
            
            .report-form {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header Image - Fixed at top -->
    <img src="assets/head.png" alt="Header" class="header-image">

    <main class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-8 col-lg-6">
                <div class="main-card">
                    <!-- Back Button -->
                    <a href="wealth.html" class="back-btn">
                        <i class="fas fa-arrow-left"></i>
                        Back to Wealth Management
                    </a>

                    <div class="page-title">
                        Download Annual Report
                    </div>

                    <!-- Report Form -->
                    <div class="report-form">
                        <div class="form-group">
                            <label for="yearSelect" class="form-label">Select Year for Report</label>
                            <select class="form-select" id="yearSelect">
                                <!-- Years will be populated dynamically -->
                            </select>
                        </div>

                        <!-- Status Messages -->
                        <div id="successMessage" class="status-message success-message">
                            <i class="fas fa-check-circle me-2"></i>
                            Report downloaded successfully!
                        </div>

                        <div id="errorMessage" class="status-message error-message">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <span id="errorText">Error downloading report</span>
                        </div>

                        <!-- Download Button -->
                        <button id="downloadPdfBtn" class="download-btn">
                            <i class="fas fa-download me-2"></i>
                            Download Annual Report PDF
                        </button>
                    </div>

                    <!-- Instructions -->
                    <div class="alert alert-info mt-4">
                        <h6><i class="fas fa-info-circle me-2"></i>Report Information</h6>
                        <ul class="mb-0 mt-2" style="padding-left: 20px;">
                            <li>Report will include all transactions for the selected year</li>
                            <li>Monthly subscriptions will be grouped together</li>
                            <li>Other income and expenses will be listed separately with narration</li>
                            <li>Annual summary with total income, expenses, and net balance</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer>
        <div class="footer-text">
            <p>Powered by VTSoft 2026</p>
        </div>
        <button id="themeToggle" class="theme-toggle-btn">ðŸŒž</button>
</footer>

    <!-- Loading Spinner -->
    <div id="loadingSpinner">
        <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary-orange);"></i>
        <div class="spinner-text">Generating Report...</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config - ORIGINAL
        const firebaseConfig = {
            apiKey: "AIzaSyBWswawf9tpxNwVU0BaJ6FCwCvgcjUQXlA",
            authDomain: "shipyard-nagar.firebaseapp.com",
            projectId: "shipyard-nagar",
            storageBucket: "shipyard-nagar.firebasestorage.app",
            messagingSenderId: "552855824221",
            appId: "1:552855824221:web:f709da953077475be9eab4",
            measurementId: "G-V8CQ4YCCQ5"
        };

        // Initialize Firebase - ORIGINAL
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const { jsPDF } = window.jspdf;

        let allTransactions = [];
        let selectedYear = new Date().getFullYear();

        // Function to normalize date
        function normalizeDate(dateString) {
            if (!dateString) return null;
            
            try {
                // If it's a Firebase Timestamp
                if (dateString.toDate && typeof dateString.toDate === 'function') {
                    const date = dateString.toDate();
                    return {
                        dateString: date.toISOString().split('T')[0],
                        dateObj: date
                    };
                }
                
                // If it's already in YYYY-MM-DD format
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                    const date = new Date(dateString);
                    return {
                        dateString: dateString,
                        dateObj: date
                    };
                }
                
                // If it's in ISO format
                if (dateString.includes('T')) {
                    const date = new Date(dateString);
                    return {
                        dateString: date.toISOString().split('T')[0],
                        dateObj: date
                    };
                }
                
                // Try to parse as date
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return {
                        dateString: date.toISOString().split('T')[0],
                        dateObj: date
                    };
                }
                
                console.error("Could not parse date:", dateString);
                return null;
            } catch (error) {
                console.error("Error normalizing date:", dateString, error);
                return null;
            }
        }

        // Populate year dropdown
        function populateYears() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            
            yearSelect.innerHTML = '';
            
            // Add available years from transactions
            const years = new Set();
            allTransactions.forEach(transaction => {
                if (transaction && transaction.date) {
                    try {
                        const normalizedDate = normalizeDate(transaction.originalDate || transaction.date);
                        if (normalizedDate && normalizedDate.dateObj) {
                            const year = normalizedDate.dateObj.getFullYear();
                            if (!isNaN(year)) {
                                years.add(year);
                            }
                        }
                    } catch (error) {
                        console.error("Error getting year from date:", transaction.date, error);
                    }
                }
            });
            
            // Add current year if no transactions exist
            if (years.size === 0) {
                years.add(currentYear);
            }
            
            // Add years in descending order
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === selectedYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            });
            
            // If no options, add current year
            if (sortedYears.length === 0) {
                const option = document.createElement('option');
                option.value = currentYear;
                option.textContent = currentYear;
                option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        // Load all transactions
        async function loadTransactions() {
            try {
                console.log("Loading transactions from Firestore...");
                
                const transactionsSnapshot = await db.collection('transactions').get();
                
                console.log("Total transactions found:", transactionsSnapshot.size);
                
                allTransactions = [];
                transactionsSnapshot.forEach(doc => {
                    const transaction = doc.data();
                    transaction.id = doc.id;
                    
                    // Ensure amount is a number
                    transaction.amount = parseFloat(transaction.amount) || 0;
                    
                    // Store original date for debugging
                    transaction.originalDate = transaction.date;
                    
                    // Normalize date
                    const normalizedDate = normalizeDate(transaction.date);
                    if (normalizedDate) {
                        transaction.date = normalizedDate.dateString;
                        transaction.dateObj = normalizedDate.dateObj;
                    }
                    
                    allTransactions.push(transaction);
                });
                
                console.log("Total transactions loaded:", allTransactions.length);
                console.log("Income transactions:", allTransactions.filter(t => t.type === 'income').length);
                console.log("Expense transactions:", allTransactions.filter(t => t.type === 'expense').length);
                
                return true;
            } catch (error) {
                console.error('Error loading transactions:', error);
                showError('Error loading transactions: ' + error.message);
                return false;
            }
        }

        // Show success message
        function showSuccess() {
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        // Show error message
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // Hide all messages
        function hideMessages() {
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Generate Annual Report PDF - FINAL CORRECTED VERSION
        async function generateAnnualReport() {
            if (!selectedYear) {
                showError('Please select a year');
                return;
            }
            
            // Hide any existing messages
            hideMessages();
            
            // Show loading spinner
            const loadingSpinner = document.getElementById('loadingSpinner');
            loadingSpinner.style.display = 'block';
            
            try {
                console.log(`=== GENERATING REPORT FOR YEAR ${selectedYear} ===`);
                
                // Filter transactions for selected year
                const yearTransactions = allTransactions.filter(transaction => {
                    if (!transaction || !transaction.dateObj) return false;
                    
                    try {
                        const year = transaction.dateObj.getFullYear();
                        return year === parseInt(selectedYear);
                    } catch (error) {
                        console.error("Error filtering transaction:", error);
                        return false;
                    }
                });
                
                console.log(`Year ${selectedYear} transactions:`, yearTransactions.length);
                
                if (yearTransactions.length === 0) {
                    throw new Error(`No transactions found for year ${selectedYear}`);
                }
                
                // Separate income and expense transactions
                const incomeTransactions = yearTransactions.filter(t => t.type === 'income');
                const expenseTransactions = yearTransactions.filter(t => t.type === 'expense');
                
                console.log("Income transactions:", incomeTransactions.length);
                console.log("Expense transactions:", expenseTransactions.length);
                
                // Group income by month for subscription summary
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                
                const monthlyIncome = {};
                for (let i = 0; i < 12; i++) {
                    monthlyIncome[i] = {
                        monthName: monthNames[i],
                        total: 0
                    };
                }
                
                incomeTransactions.forEach(transaction => {
                    try {
                        if (!transaction.dateObj) return;
                        
                        const month = transaction.dateObj.getMonth();
                        
                        if (month >= 0 && month < 12) {
                            monthlyIncome[month].total += transaction.amount;
                        }
                    } catch (error) {
                        console.error("Error processing income date:", transaction.date, error);
                    }
                });
                
                // Filter income transactions with narration for detailed listing
                const incomeWithNarration = incomeTransactions.filter(t => 
                    t.narration && t.narration.toString().trim().length > 0);
                
                // Filter expense transactions with narration for detailed listing
                const expenseWithNarration = expenseTransactions.filter(t => 
                    t.narration && t.narration.toString().trim().length > 0);
                
                console.log("Income with narration:", incomeWithNarration.length);
                console.log("Expense with narration:", expenseWithNarration.length);
                
                // Calculate totals (ALL transactions, including those without narration)
                let totalIncome = 0;
                incomeTransactions.forEach(t => totalIncome += t.amount);
                
                let totalExpense = 0;
                expenseTransactions.forEach(t => totalExpense += t.amount);
                
                const netBalance = totalIncome - totalExpense;
                
                console.log("Monthly income data:", monthlyIncome);
                console.log("Total income (all):", totalIncome);
                console.log("Total expense (all):", totalExpense);
                console.log("Net balance:", netBalance);
                
                // Create PDF
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.width;
                
                // Title
                doc.setFontSize(18);
                doc.setTextColor(0, 102, 204);
                doc.setFont('helvetica', 'bold');
                doc.text('SHIPYARD NAGAR RESIDENCE ASSOCIATION', pageWidth / 2, 20, { align: 'center' });
                
                // Year Report
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text(`ANNUAL REPORT - ${selectedYear}`, pageWidth / 2, 30, { align: 'center' });
                
                // Line
                doc.setDrawColor(0, 102, 204);
                doc.setLineWidth(0.5);
                doc.line(20, 35, pageWidth - 20, 35);
                
                let currentY = 45;
                
                // ========== MONTHLY SUBSCRIPTION SUMMARY ==========
                doc.setFontSize(12);
                doc.setTextColor(0, 102, 204);
                doc.setFont('helvetica', 'bold');
                doc.text('MONTHLY SUBSCRIPTION COLLECTION', 20, currentY);
                currentY += 10;
                
                // Display monthly subscription totals
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('Month', 25, currentY);
                doc.text('Total Amount', 150, currentY);
                currentY += 8;
                
                doc.setFont('helvetica', 'normal');
                let hasMonthlyData = false;
                for (let month = 0; month < 12; month++) {
                    const monthData = monthlyIncome[month];
                    if (monthData.total > 0) {
                        hasMonthlyData = true;
                        doc.text(monthData.monthName, 25, currentY);
                        doc.text(monthData.total.toFixed(2), 150, currentY);
                        currentY += 6;
                        
                        // Check page break
                        if (currentY > 250) {
                            doc.addPage();
                            currentY = 20;
                        }
                    }
                }
                
                if (!hasMonthlyData) {
                    doc.text('No subscription data available for this year', 25, currentY);
                    currentY += 6;
                }
                
                currentY += 10;
                
                // ========== OTHER INCOME TRANSACTIONS (with narration only) ==========
                if (incomeWithNarration.length > 0) {
                    if (currentY > 200) {
                        doc.addPage();
                        currentY = 20;
                    }
                    
                    doc.setFontSize(12);
                    doc.setTextColor(0, 102, 204);
                    doc.setFont('helvetica', 'bold');
                    doc.text('OTHER INCOME TRANSACTIONS', 20, currentY);
                    currentY += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Date', 25, currentY);
                    doc.text('Narration', 55, currentY);
                    doc.text('Amount', 160, currentY);
                    currentY += 8;
                    
                    doc.setFont('helvetica', 'normal');
                    // Sort by date descending
                    incomeWithNarration.sort((a, b) => {
                        try {
                            return b.dateObj - a.dateObj;
                        } catch {
                            return 0;
                        }
                    });
                    
                    incomeWithNarration.forEach(transaction => {
                        doc.text(transaction.date || 'N/A', 25, currentY);
                        
                        // Truncate long narration
                        const narration = transaction.narration && transaction.narration.length > 40 ? 
                            transaction.narration.substring(0, 37) + '...' : transaction.narration || 'N/A';
                        doc.text(narration, 55, currentY);
                        doc.text(transaction.amount.toFixed(2), 160, currentY);
                        currentY += 6;
                        
                        // Check page break
                        if (currentY > 250) {
                            doc.addPage();
                            currentY = 20;
                        }
                    });
                    
                    currentY += 10;
                }
                
                // ========== EXPENSE DETAILS (with narration only) ==========
                if (expenseWithNarration.length > 0) {
                    if (currentY > 200) {
                        doc.addPage();
                        currentY = 20;
                    }
                    
                    doc.setFontSize(12);
                    doc.setTextColor(0, 102, 204);
                    doc.setFont('helvetica', 'bold');
                    doc.text('EXPENSE DETAILS', 20, currentY);
                    currentY += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Date', 25, currentY);
                    doc.text('Narration', 55, currentY);
                    doc.text('Amount', 160, currentY);
                    currentY += 8;
                    
                    doc.setFont('helvetica', 'normal');
                    // Sort by date descending
                    expenseWithNarration.sort((a, b) => {
                        try {
                            return b.dateObj - a.dateObj;
                        } catch {
                            return 0;
                        }
                    });
                    
                    expenseWithNarration.forEach(transaction => {
                        doc.text(transaction.date || 'N/A', 25, currentY);
                        
                        // Truncate long narration
                        const narration = transaction.narration && transaction.narration.length > 40 ? 
                            transaction.narration.substring(0, 37) + '...' : transaction.narration || 'N/A';
                        doc.text(narration, 55, currentY);
                        doc.text(transaction.amount.toFixed(2), 160, currentY);
                        currentY += 6;
                        
                        // Check page break
                        if (currentY > 250) {
                            doc.addPage();
                            currentY = 20;
                        }
                    });
                }
                
                // ========== ANNUAL SUMMARY ==========
                if (currentY > 200) {
                    doc.addPage();
                    currentY = 20;
                }
                
                currentY += 10;
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.3);
                doc.line(20, currentY, pageWidth - 20, currentY);
                currentY += 10;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('ANNUAL SUMMARY', 20, currentY);
                currentY += 10;
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                
                // Income Summary
                doc.text(`Total Income:`, 25, currentY);
                doc.text(`${totalIncome.toFixed(2)}`, 140, currentY);
                currentY += 8;
                
                doc.text(`Total Expenses:`, 25, currentY);
                doc.text(`${totalExpense.toFixed(2)}`, 140, currentY);
                currentY += 10;
                
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                doc.line(20, currentY, pageWidth - 20, currentY);
                currentY += 10;
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                if (netBalance >= 0) {
                    doc.setTextColor(0, 128, 0); // Green for positive
                } else {
                    doc.setTextColor(255, 0, 0); // Red for negative
                }
                doc.text(`NET BALANCE: ${netBalance.toFixed(2)}`, 25, currentY);
                currentY += 15;
                
                // Reset text color
                doc.setTextColor(0, 0, 0);
                
                // Treasurer signature
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Treasurer', pageWidth - 30, currentY, { align: 'right' });
                doc.text('Vishnu T', pageWidth - 30, currentY + 6, { align: 'right' });
                
                // Footer
                const footerY = doc.internal.pageSize.height - 10;
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'italic');
                doc.text('System generated report', pageWidth / 2, footerY, { align: 'center' });
                
                // Save PDF
                const fileName = `Annual_Report_${selectedYear}.pdf`;
                doc.save(fileName);
                
                // Show success message
                showSuccess();
                
            } catch (error) {
                console.error('Error generating report:', error);
                showError(error.message);
            } finally {
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
            }
        }

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', () => {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');

            // Auth State Check
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    alert('No user logged in. Redirecting to login...');
                    window.location.href = 'login.html';
                    return;
                }

                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists || userDoc.data().role !== 'admin') {
                    alert('Permission denied. Only admins can access this page. Redirecting to login...');
                    window.location.href = 'login.html';
                    return;
                }

                // Load transactions
                loadingSpinner.style.display = 'block';
                const success = await loadTransactions();
                if (success) {
                    populateYears();
                }
                loadingSpinner.style.display = 'none';
            });

            // Year selection change
            document.getElementById('yearSelect').addEventListener('change', (e) => {
                selectedYear = parseInt(e.target.value);
            });

            // Download PDF button
            downloadPdfBtn.addEventListener('click', generateAnnualReport);

            // Theme Toggle
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const html = document.documentElement;
                    const currentTheme = html.getAttribute('data-theme');
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    html.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                    
                    themeToggle.textContent = newTheme === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
                });

                // Set initial theme
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                themeToggle.textContent = savedTheme === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
            }
        });
    </script>
</body>
</html>