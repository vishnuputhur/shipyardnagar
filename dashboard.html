<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipyard Nagar - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #fafafa; }
        header h1 { text-align: center; margin: 20px 0; }
        footer {
            position: fixed; bottom: 0; width: 100%; text-align: center;
            padding: 10px; background: #f8f8f8; color: #333;
        }
        .button-grid {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .card {
            margin-top: 20px; padding: 15px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;
        }
        .card:hover { box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); }
        #subscriptionTable { margin-top: 20px; overflow-x: auto; }
        #subscriptionTable th, #subscriptionTable td {
            padding: 10px; text-align: center; min-width: 100px;
        }
        #loadingSpinner {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 2rem; color: #0288d1;
        }
    </style>
</head>
<body>
    <header>
        <h1>Shipyard Nagar - Admin Dashboard</h1>
    </header>

    <main class="container my-4">
        <div id="loadingSpinner">⏳ Loading...</div>
        <button class="btn btn-danger mb-3" id="logout">Logout</button>

        <div class="button-grid">
            <button class="btn btn-primary" id="addUserBtn">Add Member</button>
            <button class="btn btn-primary" id="editMemberBtn">Edit Member</button>
            <button class="btn btn-primary" id="subscriptionBtn">Subscriptions</button>
            <button class="btn btn-secondary" id="refreshTotal">Refresh Total</button>
        </div>

        <!-- Add Member -->
        <div class="card" id="addUserSection" style="display:none;">
            <h2>Add Member</h2>
            <form id="addUserForm" class="p-3">
                <div class="row">
                    <div class="col-12 mb-3"><label>Member Number:</label><input type="text" id="memberNumber" class="form-control" required></div>
                    <div class="col-12 mb-3"><label>Name:</label><input type="text" id="memberName" class="form-control" required></div>
                    <div class="col-12 mb-3"><label>House Name:</label><input type="text" id="homeName" class="form-control" required></div>
                    <div class="col-12 mb-3"><label>Email:</label><input type="email" id="email" class="form-control" required></div>
                    <div class="col-12 mb-3"><label>Password:</label><input type="password" id="password" class="form-control" required></div>
                    <div class="col-12 mb-3"><label>Primary Mobile:</label><input type="text" id="primaryMobile" class="form-control" required></div>
                    <div class="col-12 mb-3"><label><input type="checkbox" id="isAdmin"> Admin</label></div>
                </div>
                <button type="submit" class="btn btn-primary">Add Member</button>
            </form>
        </div>

        <!-- Edit Member -->
        <div class="card" id="editMemberSection" style="display:none;">
            <h2>Edit Member</h2>
            <div class="p-3">
                <label>Member Number:</label>
                <input type="text" id="editMemberNumber" class="form-control mb-3" required>
                <button class="btn btn-warning mb-3" id="loadEditMember">Load Member</button>
            </div>
            <form id="editMemberForm" class="p-3" style="display:none;">
                <div class="row">
                    <div class="col-12 mb-3"><label>Name:</label><input type="text" id="editName" class="form-control" required></div>
                    <div class="col-12 mb-3"><label>House Name:</label><input type="text" id="editHomeName" class="form-control" required></div>
                    <div class="col-12 mb-3"><label>Email:</label><input type="email" id="editEmail" class="form-control" required></div>
                    <div class="col-12 mb-3"><label>Primary Mobile:</label><input type="text" id="editPrimaryMobile" class="form-control" required></div>
                    <div class="col-12 mb-3"><label><input type="checkbox" id="editIsAdmin"> Admin</label></div>
                </div>
                <button type="submit" class="btn btn-primary">Update Member</button>
            </form>
        </div>

        <!-- Subscriptions -->
        <div class="card" id="subscriptionSection" style="display:none;">
            <h2>Subscriptions</h2>
            <select id="monthSelect" class="form-select mb-3"></select>
            <button id="editMonth" class="btn btn-warning mb-3" data-editing="false">Edit Month</button>
            <table class="table table-bordered">
                <thead>
                    <tr id="monthHeaders"><th>Member Name</th></tr>
                </thead>
                <tbody id="subscriptionTable"></tbody>
            </table>
            <p id="totalWealthDisplay">Total Wealth: ₹0</p>
        </div>
    </main>

    <footer><p>Powered by VTSoft 2025</p></footer>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBWswawf9tpxNwVU0BaJ6FCwCvgcjUQXlA",
            authDomain: "shipyard-nagar.firebaseapp.com",
            projectId: "shipyard-nagar",
            storageBucket: "shipyard-nagar.firebasestorage.app",
            messagingSenderId: "552855824221",
            appId: "1:552855824221:web:f709da953077475be9eab4",
            measurementId: "G-V8CQ4YCCQ5"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            const spinner = document.getElementById('loadingSpinner');

            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    alert('Please login as admin.');
                    window.location.href = 'login.html';
                    return;
                }

                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    const userData = userDoc.data();
                    if (!userData || userData.role !== 'admin') {
                        alert('Unauthorized access!');
                        await auth.signOut();
                        window.location.href = 'login.html';
                        return;
                    }
                } catch (err) {
                    alert('Error checking admin role: ' + err.message);
                    return;
                }

                spinner.style.display = 'none';
                setupUI();
            });
        });

        function setupUI() {
            const addUserBtn = document.getElementById('addUserBtn');
            const editMemberBtn = document.getElementById('editMemberBtn');
            const subscriptionBtn = document.getElementById('subscriptionBtn');
            const logoutBtn = document.getElementById('logout');
            const refreshTotalBtn = document.getElementById('refreshTotal');

            const addUserSection = document.getElementById('addUserSection');
            const editMemberSection = document.getElementById('editMemberSection');
            const subscriptionSection = document.getElementById('subscriptionSection');

            addUserBtn.onclick = () => {
                addUserSection.style.display = 'block';
                editMemberSection.style.display = 'none';
                subscriptionSection.style.display = 'none';
            };

            editMemberBtn.onclick = () => {
                addUserSection.style.display = 'none';
                editMemberSection.style.display = 'block';
                subscriptionSection.style.display = 'none';
            };

            subscriptionBtn.onclick = () => {
                addUserSection.style.display = 'none';
                editMemberSection.style.display = 'none';
                subscriptionSection.style.display = 'block';
                loadSubscriptions();
            };

            logoutBtn.onclick = async () => {
                await auth.signOut();
                window.location.href = 'login.html';
            };

            refreshTotalBtn.onclick = refreshTotal;

            document.getElementById('addUserForm').onsubmit = addMember;
            document.getElementById('loadEditMember').onclick = loadMember;
            document.getElementById('editMemberForm').onsubmit = updateMember;
        }

        async function addMember(e) {
            e.preventDefault();
            const data = {
                memberNumber: memberNumber.value,
                memberName: memberName.value,
                homeName: homeName.value,
                email: email.value,
                primaryMobile: primaryMobile.value,
                role: isAdmin.checked ? 'admin' : 'member'
            };
            try {
                const userCred = await auth.createUserWithEmailAndPassword(email.value, password.value);
                await db.collection('users').doc(userCred.user.uid).set(data);
                alert('Member added!');
                e.target.reset();
            } catch (err) {
                alert('Error adding: ' + err.message);
            }
        }

        async function loadMember() {
            const num = document.getElementById('editMemberNumber').value;
            const snap = await db.collection('users').where('memberNumber', '==', num).get();
            if (snap.empty) { alert('Not found'); return; }
            const d = snap.docs[0].data();
            editName.value = d.memberName;
            editHomeName.value = d.homeName;
            editEmail.value = d.email;
            editPrimaryMobile.value = d.primaryMobile;
            editIsAdmin.checked = d.role === 'admin';
            document.getElementById('editMemberForm').style.display = 'block';
        }

        async function updateMember(e) {
            e.preventDefault();
            const num = editMemberNumber.value;
            const snap = await db.collection('users').where('memberNumber', '==', num).get();
            if (snap.empty) { alert('Not found'); return; }
            const docRef = snap.docs[0].ref;
            await docRef.update({
                memberName: editName.value,
                homeName: editHomeName.value,
                email: editEmail.value,
                primaryMobile: editPrimaryMobile.value,
                role: editIsAdmin.checked ? 'admin' : 'member'
            });
            alert('Updated!');
            e.target.reset();
            e.target.style.display = 'none';
        }

        async function loadSubscriptions() {
            const spinner = document.getElementById('loadingSpinner');
            spinner.style.display = 'block';
            const monthHeaders = document.getElementById('monthHeaders');
            const subscriptionTable = document.getElementById('subscriptionTable');
            const editBtn = document.getElementById('editMonth');

            const startMonth = new Date(2025, 9, 1);
            const currentMonth = new Date();
            const months = [];
            for (let d = new Date(startMonth); d <= currentMonth; d.setMonth(d.getMonth() + 1)) {
                months.push(d.toISOString().slice(0, 7));
            }

            monthHeaders.innerHTML = '<th>Member Name</th>' + months.map(m => `<th>${m}</th>`).join('');

            const membersSnap = await db.collection('users').get();
            subscriptionTable.innerHTML = '';

            for (const doc of membersSnap.docs) {
                const member = doc.data();
                const row = document.createElement('tr');
                let cells = `<td>${member.memberName}</td>`;
                for (const month of months) {
                    const cDoc = await db.collection('contributions').doc(doc.id).collection('months').doc(month).get();
                    const paid = cDoc.exists && cDoc.data().paid;
                    cells += `<td><input type="checkbox" data-member="${doc.id}" data-month="${month}" ${paid ? 'checked' : ''} ${editBtn.dataset.editing === 'true' ? '' : 'disabled'}></td>`;
                }
                row.innerHTML = cells;
                subscriptionTable.appendChild(row);
            }

            spinner.style.display = 'none';

            editBtn.onclick = () => {
                const editing = editBtn.dataset.editing === 'true';
                editBtn.dataset.editing = (!editing).toString();
                editBtn.textContent = editing ? 'Edit Month' : 'Save Month';
                loadSubscriptions();
            };

            subscriptionTable.onchange = async (e) => {
                if (e.target.tagName !== 'INPUT') return;
                const memberId = e.target.dataset.member;
                const month = e.target.dataset.month;
                const paid = e.target.checked;
                if (paid) {
                    await db.collection('contributions').doc(memberId).collection('months').doc(month).set({
                        paid: true, date: new Date().toISOString().split('T')[0], amount: 200
                    });
                    await db.collection('transactions').add({
                        type: 'income', memberId, amount: 200,
                        head: `Monthly Subscription - ${month}`,
                        date: new Date().toISOString().split('T')[0]
                    });
                } else {
                    if (confirm('Remove this payment?')) {
                        await db.collection('contributions').doc(memberId).collection('months').doc(month).delete();
                    } else e.target.checked = true;
                }
                refreshTotal();
            };
        }

        async function refreshTotal() {
            let income = 0, expense = 0;
            const tx = await db.collection('transactions').get();
            tx.forEach(doc => {
                const d = doc.data();
                if (d.type === 'income') income += d.amount || 0;
                else if (d.type === 'expense') expense += d.amount || 0;
            });
            const total = income - expense;
            document.getElementById('totalWealthDisplay').textContent = `Total Wealth: ₹${total}`;
        }
    </script>
</body>
</html>