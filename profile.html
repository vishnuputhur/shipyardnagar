<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipyard Nagar - Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Footer Fixed at Bottom */
        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            text-align: center;
            padding: 10px;
            background: #f8f8f8;
            color: #333;
            z-index: 1000;
        }

        /* Profile Display Style */
        .profile-display {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .profile-display h2 {
            font-size: 1.5rem;
            color: #0288d1;
            margin-bottom: 15px;
        }

        .profile-display .name {
            font-weight: bold;
            color: #1a237e; /* Unique color for name */
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .profile-display .small-text {
            font-size: 0.9rem;
            color: #666;
            margin: 5px 0;
        }

        .profile-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .profile-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #editProfileBtn {
            background-color: #0288d1;
            color: white;
        }

        #editProfileBtn:hover {
            background-color: #01579b;
        }

        #signoutBtn {
            background-color: #d32f2f;
            color: white;
        }

        #signoutBtn:hover {
            background-color: #b71c1c;
        }

        .edit-form {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .edit-form .form-label {
            font-weight: bold;
            color: #333;
        }

        .edit-form .form-control {
            margin-bottom: 10px;
        }

        .edit-form button {
            background-color: #0288d1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .edit-form button:hover {
            background-color: #01579b;
        }
    </style>
</head>
<body>
    <header>
        <h1>Shipyard Nagar Residential Association</h1>
    </header>
    <main class="container my-4">
        <div class="profile-display">
            <h2>My Profile</h2>
            <p class="name" id="memberName">Loading...</p>
            <p class="small-text" id="memberNumber">Member Number: Loading...</p>
            <p class="small-text" id="homeName">House Name: Loading...</p>
            <p class="small-text" id="email">Email: Loading...</p>
            <p class="small-text" id="primaryMobile">Primary Mobile: Loading...</p>
            <p class="small-text" id="secondaryMobile">Secondary Mobile: Loading...</p>
            <p class="small-text" id="gasConnection">Gas Connection: Loading...</p>
        </div>
        <div class="profile-buttons">
            <button id="editProfileBtn">Edit Profile</button>
            <button id="signoutBtn">Signout</button>
        </div>
        <div class="edit-form" id="editForm">
            <h2>Edit Profile</h2>
            <form id="profileForm">
                <div class="mb-3">
                    <label for="editHomeName" class="form-label">House Name:</label>
                    <input type="text" class="form-control" id="editHomeName">
                </div>
                <div class="mb-3">
                    <label for="editEmail" class="form-label">Email:</label>
                    <input type="email" class="form-control" id="editEmail">
                </div>
                <div class="mb-3">
                    <label for="editPrimaryMobile" class="form-label">Primary Mobile:</label>
                    <input type="text" class="form-control" id="editPrimaryMobile">
                </div>
                <div class="mb-3">
                    <label for="editSecondaryMobile" class="form-label">Secondary Mobile:</label>
                    <input type="text" class="form-control" id="editSecondaryMobile">
                </div>
                <div class="mb-3">
                    <label for="editGasConnection" class="form-label">Gas Connection:</label>
                    <select id="editGasConnection" class="form-select">
                        <option value="Indian">Indian</option>
                        <option value="HP">HP</option>
                        <option value="BPCL">BPCL</option>
                        <option value="Others">Others</option>
                    </select>
                </div>
                <button type="submit" class="btn">Save</button>
            </form>
        </div>
    </main>
    <footer class="bg-light text-center py-2">
        <p>Powered by VTSoft 2025</p>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBWswawf9tpxNwVU0BaJ6FCwCvgcjUQXlA",
            authDomain: "shipyard-nagar.firebaseapp.com",
            projectId: "shipyard-nagar",
            storageBucket: "shipyard-nagar.firebasestorage.app",
            messagingSenderId: "552855824221",
            appId: "1:552855824221:web:f709da953077475be9eab4",
            measurementId: "G-V8CQ4YCCQ5"
        };

        // Initialize Firebase
        let auth, db;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('Firebase initialized successfully');
        } catch (error) {
            alert('Firebase Initialization Error: ' + error.message);
            console.error('Firebase Init Error:', error);
        }

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', () => {
            const memberNameEl = document.getElementById('memberName');
            const memberNumberEl = document.getElementById('memberNumber');
            const homeNameEl = document.getElementById('homeName');
            const emailEl = document.getElementById('email');
            const primaryMobileEl = document.getElementById('primaryMobile');
            const secondaryMobileEl = document.getElementById('secondaryMobile');
            const gasConnectionEl = document.getElementById('gasConnection');
            const editProfileBtn = document.getElementById('editProfileBtn');
            const editForm = document.getElementById('editForm');
            const profileForm = document.getElementById('profileForm');
            const signoutBtn = document.getElementById('signoutBtn');

            if (!memberNameEl || !editProfileBtn || !signoutBtn) {
                console.error('Required DOM elements not found');
                return;
            }

            // Auth State Check and Data Load
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }

                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        console.log('User Data:', userData);

                        memberNameEl.textContent = userData.memberName || 'N/A';
                        memberNumberEl.textContent = 'Member Number: ' + (userData.memberNumber || 'N/A');
                        homeNameEl.textContent = 'House Name: ' + (userData.homeName || 'N/A');
                        emailEl.textContent = 'Email: ' + (userData.email || 'N/A');
                        primaryMobileEl.textContent = 'Primary Mobile: ' + (userData.primaryMobile || 'N/A');
                        secondaryMobileEl.textContent = 'Secondary Mobile: ' + (userData.secondaryMobile || 'N/A');
                        gasConnectionEl.textContent = 'Gas Connection: ' + (userData.gasConnection || 'N/A');

                        // Pre-fill Edit Form
                        document.getElementById('editHomeName').value = userData.homeName || '';
                        document.getElementById('editEmail').value = userData.email || '';
                        document.getElementById('editPrimaryMobile').value = userData.primaryMobile || '';
                        document.getElementById('editSecondaryMobile').value = userData.secondaryMobile || '';
                        document.getElementById('editGasConnection').value = userData.gasConnection || 'Indian';
                    } else {
                        console.error(`User data not found for UID: ${user.uid}`);
                        memberNameEl.textContent = 'N/A';
                        memberNumberEl.textContent = 'Member Number: N/A';
                        homeNameEl.textContent = 'House Name: N/A';
                        emailEl.textContent = 'Email: N/A';
                        primaryMobileEl.textContent = 'Primary Mobile: N/A';
                        secondaryMobileEl.textContent = 'Secondary Mobile: N/A';
                        gasConnectionEl.textContent = 'Gas Connection: N/A';
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    alert('Error loading profile data: ' + error.message);
                    memberNameEl.textContent = 'N/A';
                    memberNumberEl.textContent = 'Member Number: N/A';
                    homeNameEl.textContent = 'House Name: N/A';
                    emailEl.textContent = 'Email: N/A';
                    primaryMobileEl.textContent = 'Primary Mobile: N/A';
                    secondaryMobileEl.textContent = 'Secondary Mobile: N/A';
                    gasConnectionEl.textContent = 'Gas Connection: N/A';
                }
            });

            // Edit Profile Button
            editProfileBtn.addEventListener('click', () => {
                if (editForm) {
                    editForm.style.display = 'block';
                } else {
                    console.error('Edit form element not found');
                }
            });

            // Form Submission
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const user = auth.currentUser;
                    if (user) {
                        try {
                            await db.collection('users').doc(user.uid).update({
                                homeName: document.getElementById('editHomeName').value,
                                email: document.getElementById('editEmail').value,
                                primaryMobile: document.getElementById('editPrimaryMobile').value,
                                secondaryMobile: document.getElementById('editSecondaryMobile').value,
                                gasConnection: document.getElementById('editGasConnection').value
                            });
                            alert('Saved');
                            if (editForm) editForm.style.display = 'none';
                            // Reload page to reflect updated data
                            window.location.reload();
                        } catch (error) {
                            alert('Error saving profile: ' + error.message);
                            console.error('Save Error:', error);
                        }
                    }
                });
            }

            // Signout Button
            signoutBtn.addEventListener('click', () => {
                auth.signOut()
                    .then(() => {
                        alert('Signed out successfully!');
                        window.location.href = 'login.html';
                    })
                    .catch((error) => {
                        alert('Signout Error: ' + error.message);
                        console.error('Signout Error:', error);
                    });
            });
        });
    </script>
</body>
</html>