<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPI Payment</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #fff;
            overflow: hidden;
        }
    </style>
</head>
<body>
<script>
window.onload = async function () {
    try {
        // ðŸ”¹ Read URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const amount = urlParams.get("amount") || "100";
        const member = urlParams.get("member") || "1";

        // ðŸ”¹ Your UPI ID
        const upiId = "vishnuputhur@sbi";

        // ðŸ”¹ Construct valid UPI payment URL
        const upiURL = `upi://pay?pa=${upiId}&pn=ShipyardNagar&am=${amount}&cu=INR&tn=Member${member}`;

        console.log("Generating QR for:", upiURL);

        // ðŸ”¹ Generate QR image as DataURL (callback style for max support)
        QRCode.toDataURL(upiURL, { width: 400, margin: 1 }, async function (err, qrDataUrl) {
            if (err) {
                console.error("QR Generation Error:", err);
                alert("QR Code generation failed ðŸ˜”");
                window.close();
                return;
            }

            console.log("QR generated successfully");

            // ðŸ”¹ Convert base64 â†’ blob
            const response = await fetch(qrDataUrl);
            const blob = await response.blob();
            const file = new File([blob], `upi_payment_${amount}.png`, { type: "image/png" });

            // ðŸ”¹ Try sharing QR image
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                console.log("Sharing QR...");
                await navigator.share({
                    files: [file],
                    title: "UPI Payment - Shipyard Nagar",
                    text: `Scan this QR to pay â‚¹${amount}`
                });
                console.log("Share success");
                setTimeout(() => window.close(), 1000);
            } else {
                console.log("Share not supported, downloading...");
                const a = document.createElement("a");
                a.href = qrDataUrl;
                a.download = `upi_payment_${amount}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => window.close(), 2000);
            }
        });

    } catch (e) {
        console.error("Unexpected error:", e);
        alert("QR generation failed!");
        setTimeout(() => window.close(), 2000);
    }
};
</script>
</body>
</html>