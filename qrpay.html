<!DOCTYPE html>
<html lang="ml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Pay</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0;
           display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh;
           background:#faf8e3; color:#111; }
    .card { background:#fff; border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,0.08); text-align:center; width:92%; max-width:420px; }
    h1{font-size:1.05rem;margin:0 0 10px}
    p.small{font-size:0.85rem;color:#444;margin:6px 0 12px}
    canvas{width:280px;height:280px; border-radius:8px; background:#fff}
    .controls{display:flex; gap:8px; justify-content:center; margin-top:12px}
    button{padding:10px 14px;border-radius:10px;border:0;background:#2e7d32;color:#fff;font-weight:600;cursor:pointer}
    a.download{background:#1565c0}
    .note{font-size:0.78rem;color:#666;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h1>മാസവരി അടയ്ക്കുക</h1>
    <p class="small">QR സ്കാൻ ചെയ്ത് പേയ് ചെയ്യുക (amount URL query ഉപയോഗിക്കുന്നു)</p>

    <!-- QR will be injected here -->
    <div id="qrHolder" aria-hidden="false"></div>

    <div class="controls">
      <button id="downloadBtn">Download QR</button>
      <button id="copyBtn">Copy UPI Text</button>
    </div>

    <p class="note">ഒരു ഡിവൈസിലാണെങ്കിൽ: GPay/PhonePe → Scan from gallery → ഈ ചിത്രം സെലക്ട് ചെയ്ത് പണം അയക്കുക.<br>
    അല്ലെങ്കിൽ മറ്റൊരു ഫോൺ ഉപയോഗിച്ച് screen-ലുള്ള QR സ്കാൻ ചെയ്യുക.</p>
  </div>

<script>
(async function(){
  // URL param amount (default 200)
  const params = new URLSearchParams(window.location.search);
  const amount = params.get('amount') || '200';

  // YOUR UPI ID (change if needed)
  const upiId = '9037383927@ybl'; // <-- set your UPI id here
  const payerName = 'Shipyard Nagar'; // display name
  const note = 'Monthly Payment';

  if (!amount || isNaN(amount) || Number(amount) < 1) {
    alert('Invalid amount. Use ?amount=200 in URL');
    return;
  }

  // Construct UPI URI (do not over-encode)
  const upiURI = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(payerName)}&am=${encodeURIComponent(amount)}&cu=INR&tn=${encodeURIComponent(note)}`;

  // Create canvas and generate QR using callback style
  const canvas = document.createElement('canvas');
  canvas.width = 400;
  canvas.height = 400;

  const holder = document.getElementById('qrHolder');
  holder.innerHTML = ''; // clear
  holder.appendChild(canvas);

  QRCode.toCanvas(canvas, upiURI, { width: 400, margin: 1 }, function(err) {
    if (err) {
      console.error('QR gen error', err);
      holder.innerHTML = '<p style="color:#b00020">QR generation failed. Check console.</p>';
      return;
    }
    // Scale canvas visually for mobile
    canvas.style.width = '280px';
    canvas.style.height = '280px';
  });

  // Download button
  document.getElementById('downloadBtn').addEventListener('click', function(){
    try {
      const dataUrl = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = `upi_qr_${amount}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    } catch(e){
      alert('Download not supported in this environment.');
      console.error(e);
    }
  });

  // Copy UPI text (for manual paste)
  document.getElementById('copyBtn').addEventListener('click', async function(){
    const text = `upi://${upiURI.slice(6)}`; // keep as upi://...
    try {
      await navigator.clipboard.writeText(text);
      alert('UPI text copied to clipboard. Paste in UPI app if needed.');
    } catch (e) {
      // fallback
      prompt('Copy this UPI text:', text);
    }
  });

})();
</script>
</body>
</html>