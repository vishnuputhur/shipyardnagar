<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Payment - Shipyard Nagar</title>
    <!-- Razorpay Checkout Script (Live) -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .loading-container {
            text-align: center;
            color: white;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF6B35;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Processing Payment...</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBWswawf9tpxNwVU0BaJ6FCwCvgcjUQXlA",
            authDomain: "shipyard-nagar.firebaseapp.com",
            projectId: "shipyard-nagar",
            storageBucket: "shipyard-nagar.firebasestorage.app",
            messagingSenderId: "552855824221",
            appId: "1:552855824221:web:f709da953077475be9eab4",
            measurementId: "G-V8CQ4YCCQ5"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const memberNumber = urlParams.get('member') || 'Unknown';
        const monthlyAmount = parseInt(urlParams.get('monthly')) || 0;
        const speakerAmount = parseInt(urlParams.get('speaker')) || 0;
        const pendingMonths = urlParams.get('months') || '0';
        const totalAmount = monthlyAmount + speakerAmount;

        // Start Razorpay payment immediately
        function initiateRazorpayPayment() {
            if (totalAmount < 10) {
                alert('Minimum payment amount is â‚¹10');
                window.history.back();
                return;
            }

            const options = {
                key: "rzp_live_RgUX7aqPVgwhwH",
                amount: totalAmount * 100,
                currency: "INR",
                name: "Shipyard Nagar",
                description: `Member ${memberNumber} - Monthly Subscription`,
                image: "https://vishnuputhur.github.io/shipyardnagar/assets/logo.jpg",
                handler: async function(response) {
                    await processPaymentSuccess(response);
                },
                prefill: {
                    name: "Member " + memberNumber,
                    contact: "",
                    email: ""
                },
                theme: {
                    color: "#FF6B35"
                },
                modal: {
                    ondismiss: function() {
                        // User closed the modal, go back
                        window.history.back();
                    }
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        }

        // Process payment success
        async function processPaymentSuccess(response) {
            try {
                // Here you would typically verify the payment with your backend
                // For now, we'll assume payment is successful
                
                // Update Firebase records
                await updateFirebaseRecords(response.razorpay_payment_id);
                
                alert('Payment successful! Your subscription has been updated.');
                
                // Redirect back to main page
                setTimeout(() => {
                    window.location.href = 'https://vishnuputhur.github.io/shipyardnagar/index.html';
                }, 2000);
                
            } catch (error) {
                console.error('Payment processing error:', error);
                alert('Payment successful but there was an error updating records. Please contact admin.');
                window.history.back();
            }
        }

        // Update Firebase records
        async function updateFirebaseRecords(paymentId) {
            try {
                const user = auth.currentUser;
                if (!user) {
                    console.error('User not authenticated');
                    return;
                }

                const batch = db.batch();
                const today = new Date().toISOString().slice(0, 10);

                // Get pending months from URL or calculate
                const monthsCount = parseInt(pendingMonths) || 0;
                
                // Mark months as paid (you might need to adjust this logic based on your actual month tracking)
                if (monthsCount > 0) {
                    // Add your logic to mark specific months as paid
                    console.log(`Marking ${monthsCount} months as paid`);
                }

                // Mark speaker as paid if speaker amount > 0
                if (speakerAmount > 0) {
                    const userRef = db.collection('users').doc(user.uid);
                    batch.set(userRef, { speakerPaid: true }, { merge: true });

                    const speakerTransactionRef = db.collection('transactions').doc();
                    batch.set(speakerTransactionRef, {
                        type: 'income',
                        memberId: user.uid,
                        memberNumber: memberNumber,
                        amount: speakerAmount,
                        head: 'Speaker Contribution',
                        date: today,
                        paymentId: paymentId,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // Add main transaction record
                const transactionRef = db.collection('transactions').doc();
                batch.set(transactionRef, {
                    type: 'income',
                    memberId: user.uid,
                    memberNumber: memberNumber,
                    amount: totalAmount,
                    head: 'Monthly Subscription Payment',
                    date: today,
                    paymentId: paymentId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                await batch.commit();
                console.log('Firebase records updated successfully');
                
            } catch (error) {
                console.error('Error updating Firebase records:', error);
                throw error;
            }
        }

        // Wait for Firebase auth to be ready, then start payment
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in, start payment
                setTimeout(initiateRazorpayPayment, 1000);
            } else {
                // User not signed in, redirect to login
                alert('Please login first');
                window.location.href = 'https://vishnuputhur.github.io/shipyardnagar/login.html';
            }
        });

        // If auth takes too long, start payment anyway (for guest users)
        setTimeout(() => {
            if (!auth.currentUser) {
                initiateRazorpayPayment();
            }
        }, 3000);
    </script>
</body>
</html>