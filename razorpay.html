<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Payment - Shipyard Nagar</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .loading-container {
            text-align: center;
            color: white;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF6B35;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Processing Payment...</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration (No Auth - Direct Access)
        const firebaseConfig = {
            apiKey: "AIzaSyBWswawf9tpxNwVU0BaJ6FCwCvgcjUQXlA",
            projectId: "shipyard-nagar",
            storageBucket: "shipyard-nagar.firebasestorage.app",
            messagingSenderId: "552855824221",
            appId: "1:552855824221:web:f709da953077475be9eab4"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const memberNumber = urlParams.get('member') || 'Unknown';
        const monthlyAmount = parseInt(urlParams.get('monthly')) || 0;
        const speakerAmount = parseInt(urlParams.get('speaker')) || 0;
        const pendingMonths = urlParams.get('months') || '0';
        const totalAmount = monthlyAmount + speakerAmount;

        // Start Razorpay payment immediately
        function initiateRazorpayPayment() {
            if (totalAmount < 10) {
                alert('Minimum payment amount is â‚¹10');
                window.history.back();
                return;
            }

            const options = {
                key: "rzp_live_RgUX7aqPVgwhwH",
                amount: totalAmount * 100,
                currency: "INR",
                name: "Shipyard Nagar",
                description: `Member ${memberNumber} - Monthly Subscription`,
                image: "https://vishnuputhur.github.io/shipyardnagar/assets/logo.jpg",
                handler: async function(response) {
                    await processPaymentSuccess(response);
                },
                prefill: {
                    name: "Member " + memberNumber,
                    contact: "",
                    email: ""
                },
                theme: {
                    color: "#FF6B35"
                },
                modal: {
                    ondismiss: function() {
                        window.history.back();
                    }
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        }

        // Process payment success - Update Firebase without authentication
        async function processPaymentSuccess(response) {
            try {
                const paymentId = response.razorpay_payment_id;
                const today = new Date().toISOString().slice(0, 10);
                
                // Create transaction record
                await db.collection('transactions').add({
                    type: 'income',
                    memberNumber: memberNumber,
                    amount: totalAmount,
                    monthlyAmount: monthlyAmount,
                    speakerAmount: speakerAmount,
                    head: 'Monthly Subscription Payment',
                    date: today,
                    paymentId: paymentId,
                    pendingMonths: pendingMonths,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update user's payment status
                await updateUserPaymentStatus(memberNumber, paymentId, today);
                
                alert('Payment successful! Records updated automatically.');
                
                // Redirect back to main page
                setTimeout(() => {
                    window.location.href = 'https://vishnuputhur.github.io/shipyardnagar/index.html?payment=success&id=' + paymentId;
                }, 2000);
                
            } catch (error) {
                console.error('Payment processing error:', error);
                alert('Payment successful! Please note your Payment ID: ' + response.razorpay_payment_id + ' and contact admin for manual update.');
                window.history.back();
            }
        }

        // Update user's payment status in Firestore
        async function updateUserPaymentStatus(memberNumber, paymentId, date) {
            try {
                // Find user by member number
                const usersSnapshot = await db.collection('users')
                    .where('memberNumber', '==', memberNumber)
                    .get();

                if (!usersSnapshot.empty) {
                    const userDoc = usersSnapshot.docs[0];
                    const userId = userDoc.id;
                    
                    // Update speaker payment if applicable
                    if (speakerAmount > 0) {
                        await db.collection('users').doc(userId).update({
                            speakerPaid: true
                        });
                    }
                    
                    // Update monthly subscriptions
                    await updateMonthlySubscriptions(userId, date, paymentId);
                }
            } catch (error) {
                console.error('Error updating user status:', error);
            }
        }

        // Update monthly subscriptions
        async function updateMonthlySubscriptions(userId, date, paymentId) {
            try {
                const monthsCount = parseInt(pendingMonths);
                if (monthsCount > 0) {
                    // Get current pending months and mark them as paid
                    const contributionsRef = db.collection('contributions').doc(userId).collection('months');
                    const pendingSnapshot = await contributionsRef.where('paid', '==', false).get();
                    
                    const batch = db.batch();
                    let updatedCount = 0;
                    
                    pendingSnapshot.forEach(doc => {
                        if (updatedCount < monthsCount) {
                            batch.update(doc.ref, {
                                paid: true,
                                date: date,
                                paymentId: paymentId
                            });
                            updatedCount++;
                        }
                    });
                    
                    await batch.commit();
                }
            } catch (error) {
                console.error('Error updating subscriptions:', error);
            }
        }

        // Start payment immediately
        window.onload = function() {
            setTimeout(initiateRazorpayPayment, 1000);
        };
    </script>
</body>
</html>